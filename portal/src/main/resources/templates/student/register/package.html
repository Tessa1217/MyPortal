<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/student_layout}">
<!-- CSS only -->
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
	<th:block layout:fragment="studentContent">
		<div id="main">
			<h2>수강 꾸러미 신청</h2>
			<hr>
			<div class="card">
				<div class="card-body">
			<h3>개설강의 LIST</h3>
			<br>
			<!-- 학과별 강의 검색 -->
			<form name="frmchoice">
				<select id="departCode" name="departCode">
					<option selected>--- 학과선택 ---</option>
					<optgroup label="인문대학">
						<option value="JAPA">일어일문학과</option>
						<option value="ENGL">영어영문학과</option>
					</optgroup>
					<optgroup label="사회과학대학">
						<option value="PSYC">심리학과</option>
					</optgroup>
					<optgroup label="자연과학대학">
						<option value="BIOL">생물학과</option>
						<option value="CHEM">화학공학과</option>
						<option value="PHYS">물리학과</option>
					</optgroup>
					<optgroup label="소프트웨어대학">
						<option value="ELEG">전기공학과</option>
					</optgroup>
				</select>
				<button class="btn rounded-pill btn-primary" type="submit">검색</button>
				<button class="btn rounded-pill btn-primary" type="button"
					onclick="location.href='coursePackage'">초기화</button>
			</form>
			<br>
			<!-- 강의 목록 -->
			<div class="overflow-auto" style="max-height: 300px;">
				<table class="table table-bordered table-hover">
					<thead>
						<tr>
							<th>강의 코드</th>
							<th>이수 구분</th>
							<th>강의명</th>
							<th>학점</th>
							<th>담당 교수</th>
							<th>수강 정원</th>
							<th>담기</th>
						</tr>
					</thead>
					<tbody>
						<tr th:each="item:${coursePackage}">
							<td th:text="${item.courseCode}"></td>
							<td th:text="${item.courseSortation}"></td>
							<td th:text="${item.courseName}"></td>
							<td th:text="${item.courseCredit}"></td>
							<td th:text="${item.professorName}"></td>
							<td th:text="${item.courseLimit}"></td>
							<td><button type="button"
									class="btn btn-primary buttonInsert"
									th:data-code="${item.courseCode}">담기</button></td>
						</tr>
					</tbody>
				</table>
			</div>
			</div>
		</div>
			<br>
			<!-- 담은 강의 목록 -->
			<div class="card">
				<div class="card-body">
			<h3>수강꾸러미 LIST</h3>
			<div class="overflow-auto" style="max-height: 300px;">
				<table class="table table-bordered table-hover">
					<thead>
						<tr>
							<th>강의 코드</th>
							<th>이수 구분</th>
							<th>강의명</th>
							<th>학점</th>
							<th>담당 교수</th>
							<th>취소</th>
						</tr>
					</thead>
					<tbody id="pBody">
						<tr th:each="item:${coursePackageList}" id="pTr">
							<td th:text="${item.courseCode}"></td>
							<td th:text="${item.courseSortation}"></td>
							<td th:text="${item.courseName}"></td>
							<td th:text="${item.courseCredit}"></td>
							<td th:text="${item.professorName}"></td>
							<td><button type="button"
									class="btn btn-primary buttonDelete"
									th:data-code="${item.courseCode}">취소</button></td>
						</tr>
					</tbody>
				</table>
			</div>	
		</div>
		<h6>
			수강꾸러미 신청가능 학점: <span id="total" th:text="!${coursePackagePoint}?20:20-${coursePackagePoint.packageCredit}"></span>
		</h6>
		<h6>교양신청 가능학점: 5</h6>
	</div>
		</div>
		<script th:inline="javascript">

			function creditTotalSum(){
				let creditCount = 0;

				Array.from(pBody.children).forEach(function(item) {
						creditCount += parseInt(item.children[3].textContent);
				});
				return creditCount;
			}

			function setTotalData() {
				const creditCount = creditTotalSum();
				document.getElementById("total").innerHTML = (20 - creditCount);
			}

			function lSortationCheck() {
				let creditCount = 0;

				Array.from(pBody.children).forEach(function(item) {
						if( (item.children[1].textContent).startsWith('L') ){
							creditCount += parseInt(item.children[3].textContent);
						}
				});

				return creditCount;

			}

			$(function(){
				$(".buttonInsert").on("click", coursePackageInsert)
				function coursePackageInsert(){
					let code = $(this).data("code");
	
					// let courseCodeCheck = Array.from(pBody.children).some(item => item.children[0].textContent === code);
					// if(courseCodeCheck){
					// 	return alert('담겨있는 강의입니다.');
					// } 

					let allCourseCredit = creditTotalSum();
					const selectCode = $(this)[0].parentElement.parentElement;
					const selectNum = parseInt(selectCode.children[3].textContent);
					if( (allCourseCredit + selectNum) > 20 ){
						return alert("최대 학점을 초과할수없습니다.");
					}

					if((selectCode.children[1].textContent).startsWith("L","l")) {
						let lSortationTotal = lSortationCheck();

						if( (lSortationTotal + parseInt(selectCode.children[3].textContent)) > 5 ){
							return alert("교양학점은 5점을 초과할 수 없습니다.");
						}
					}
				
					$.ajax({
						url:"/student/coursePackageInsert",
						method:"post",
						dataType:"json",
						data:{
							"courseCode" : code
						},
						dataType:"json",			
						success:function(item){
							let content=`<tr>
								<td>${item.courseCode}</td>
								<td>${item.courseSortation}</td>
								<td>${item.courseName}</td>
								<td>${item.courseCredit}</td>
								<td>${item.professorName}</td>
								<td><button type="button" class="btn btn-primary buttonDelete" data-code="${item.courseCode}">취소</button></td>
								</tr>`;
								
							$("#pBody").append(content);
							
							setTotalData();
						}
					});
				}
			})

			$(function(){
				$("#pBody").on("click",".buttonDelete",coursePackageDelete)
				function coursePackageDelete(){
					let code = $(this).data("code")
					let tr = $(this).closest("tr");
						$.ajax({
							url:"/student/coursePackageDelete",
							method:"post",
							dataType:"json",
							data:{
								"courseCode" : code
							},
							dataType:"json",
							success:function(item){
									tr.remove();

									setTotalData();
							}
						});
				}
			})
			
			
			
		</script>
	</th:block>
</body>
</html>