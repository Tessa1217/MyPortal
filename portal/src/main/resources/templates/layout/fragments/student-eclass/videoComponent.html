<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
	<th:block th:fragment="videoFragment">
	<div class="card col-8">
		<div class="card-body">
			<video id="video" height="100%" width="100%" 
			th:src="@{/video/download/{videoCode}(videoCode=${lecture.videoCode})}" 
			controls>
			</video>
		</div>
	</div>
	<script th:inline="javascript">
	$(function() {
			insertRecord();
			videoPlay();
			
			function videoPlay() {
				$("video").on({
					play : function() {
						console.log("play");
						updateRecord();
					},
					pause : function() {
						console.log("stop");
						stopUpdate();
					}
				})
			}

			// 5초마다 갱신
			function updateRecord() {
				videoTimer = setInterval(function() {
					let record = {
							studentId : $("input[name=studentId]").val(),
							lectureCode : $("input[name=lectureCode]").val(),
							lectureAttTime : $("input[name=lectureAttTime]").val(),
							watchAccumTime : document.querySelector("video").currentTime,
							cmd : 'update'
					}
					$.ajax({
						method : 'POST',
						url : '/student/watchLecture',
						contentType : 'application/json',
						data : JSON.stringify(record)
					})
				}, 5000);
			}
			
			// 비디오 멈추면 갱신 종료
			function stopUpdate() {
				clearInterval(videoTimer);
			}
	})
	
	function insertRecord() {
		
		// 레코드 객체 생성
		let record = {
				studentId : $("input[name=studentId]").val(),
				lectureCode : $("input[name=lectureCode]").val(),
				watchAccumTime : document.querySelector("video").currentTime,
				cmd : "insert"
		}
		
		// 페이지 들어가면 인서트
		$.ajax({
			method : 'POST',
			url : '/student/watchLecture',
			contentType : 'application/json',
			data : JSON.stringify(record)
		})
	}

	</script>
	</th:block>
</body>
</html>