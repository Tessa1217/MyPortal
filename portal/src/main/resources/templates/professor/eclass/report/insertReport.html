<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/professor-eclass_layout}">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
	<th:block layout:fragment="professorEclassContent">
		<div id="main">
		<div class="page-title">
			<h3>강의 과제 등록</h3>
		</div>
			<div class="cardForm card">
			<div class="card-body">
			<form name="reportFrm" th:action="@{/professor/eclass/insertReport}" method="POST" enctype="multipart/form-data">
				<input type="hidden" name="courseCode" th:value="${session.courseInfo.courseCode}">
				<input type="hidden" name="professorId" th:value="${session.id}">
				<table class="table">
					<tr>
						<th>과제명</th>
						<td><input type="text" class="form-control" name="reportTitle"></td>
					</tr>
					<tr>
						<th>강의주차</th>
						<td><select class="form-select width-three" name="weekCode">
							<option value="">주차</option>
							<th:block th:each="week : ${session.courseInfo.weekPlans}">
							<option th:value="${week.weekCode}"
							th:data-start="${#dates.format(week.weekStartDate, 'yyyy-MM-dd')}"
							th:data-end="${#dates.format(week.weekEndDate, 'yyyy-MM-dd')}"
							>[[${week.weekNum}]]</option>
							</th:block>
						</select></td>
					</tr>
					<tr>
						<th>과제 시작일</th>
						<td><input type="date" class="inline form-control width-three" name="reportStartDate">
							 ~ 
							<input class="inline form-control width-three" type="date"
							name="reportEndDate">
							</td>
						</tr>
					<tr>
						<th>과제 배점</th>
						<td><input type="number" class="inline form-control width-three" name="reportAssignedScore"> 점</td>
					</tr>
					<tr>
						<th>과제 첨부파일 업로드</th>
						<td><input type="file" class="form-control width-six inline" name="file">
						<button type="button" id="getFiles" class="inline btn btn-primary">기존 파일 불러오기</button></td>
					</tr>
					<tr>
						<th>참고사항</th>
						<td><textarea id="reportContent" name="reportContent">
						</textarea></td>
					</tr>
				</table>
				<div align="center">
					<button type="submit" class="btn btn-danger">등록하기</button>
					<button id="check" type="button" class="btn btn-primary">취소</button>
				</div>
				<div id="fileModal" class="modal" tabindex="-1"
				aria-labelledby="fileModalLabel" aria-hidden="true">
			  <div class="modal-dialog">
			    <div class="modal-content">
			      <div class="modal-header">
			        <h5 class="modal-title">내 과제 파일 모아보기</h5>
			        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			      </div>
			      <div class="modal-body">
			        <div id="oldFileList">
			        </div>
			      </div>
			      <div class="modal-footer">
			        <button type="button" id="close" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
			        <button type="button" id="file" class="btn btn-primary">파일 적용하기</button>
			      </div>
			    </div>
			  </div>
			 </div>
			</form>
			</div>
			</div>
		</div>
		<script th:inline="javascript">
			$(function() {
				enterDate("reportStartDate", "reportEndDate");
				editor();
				getFiles();
				closeModal();
				file();
				cancelInsert();
			})
			
			// 에디터 생성 
			function editor() {
				tinymce.
					init({
						selector : '#reportContent',
						submit_patch : false,
						setup: function(editor) {
							editor.on('change', function() {
								editor.save();
							})
						}
					})
			}
			
			function getFiles() {
				$(document).on("click", "#getFiles", function() {
					console.log($("input[name=professorId]").val());
					$.ajax({
						method : 'POST',
						url : `/professor/eclass/getWholeFile`,
						data : {
							submitId : $("input[name=professorId]").val(),
							userCode : '01'
						},
						success : function(result) {
							$("#oldFileList").replaceWith(result);
							$("#fileModal").show();
						}
					})
				})
			}
			
			function closeModal() {
				$("#close").on("click", function() {
					$("#fileModal").hide();
				})
			}
			
			function file() {
				$("#file").on("click", function() {
					let fileList = $("input[name=file]");
					console.log(fileList);
				})
			}
			
			function cancelInsert() {
				$(document).on("click", "#check", function() {
					fireSwal('info', '등록을 취소하시겠습니까?')
					.then((result) => {
						location.href=`/professor/eclass/reportList`
					})
				})
			}
		</script>
	</th:block>
</body>
</html>