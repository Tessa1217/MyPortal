<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/professor-eclass_layout}">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
	<th:block layout:fragment="professorEclassContent">
		<div id="main">
			<div class="page-title">
				<h2>강의 등록하기</h2>
			</div>
			<div class="card">
			<div class="card-body">
			<form name="lectureFrm" 
			th:action="@{/professor/eclass/insertLecture}" 
			method="POST" enctype="multipart/form-data"
			class="form form-horizontal">
			<input type="hidden" name="courseCode" th:value="${session.courseCode}">
				<div class="form-body width-seven">
					<div class="row formrow">
							<div class="col-md-4">
								<label>강의명</label>
							</div>
							<div class="col-md-8">
								<input type="text" name="lectureTitle" class="form-control">
							</div>
							<div class="col-md-4">
								<label>강의 주차</label>
							</div>
							<div class="col-md-8">
								<select name="weekCode" class="form-select width-three">
										<option value="">주차</option>
										<th:block th:each="week : ${courseInfo.weekPlans}">
										<option th:value="${week.weekCode}"
										th:data-start="${#dates.format(week.weekStartDate, 'yyyy-MM-dd')}"
										th:data-end="${#dates.format(week.weekEndDate, 'yyyy-MM-dd')}"
										>[[${week.weekNum}]]</option>
										</th:block>
						</select>
							</div>
							<div class="col-md-4">
								<label>강의 시작일</label>
							</div>
							<div class="col-md-8">
								<input type="date" name="lectureStartDate" class="form-control width-seven">
							</div>
							<div class="col-md-4">
								<label>강의 종료일</label>
							</div>
							<div class="col-md-8">
								<input type="date" name="lectureEndDate" class="form-control width-seven">
							</div>
							<div class="col-md-4">
								<label>출석 인정시간</label>
							</div>
							<div class="col-md-8">
								<input type="number" name="lectureAttTime" class="form-control width-seven">
							</div>
							<div class="col-md-4">
								<label>강의 파일 업로드</label>
							</div>
							<div class="col-md-8">
									<input type="file" class="form-control" style="display:inline;" th:onchange="getDuration" name="file">
									<button type="button" style="float:right;" class="btn btn-primary">기본 정보 불러오기</button>
								<input type="hidden" name="videoPlayTime">
							</div>
							<div class="col-md-4">
								<label>강의 참고사항</label>
							</div>
							<div class="col-md-8">
								<input type="text" name="lectureContent" class="form-control width-seven">
							</div>
					</div>
					<div class="btnContainer">
						<button type="submit">등록하기</button>
					</div>
				</div>
			</form>
			</div>
			</div>
		</div>
		<script th:inline="javascript">
			$(function() {
				enterDate("lectureStartDate", "lectureEndDate");
				getDuration();
			})
			
			// 비디오 업로드 시 비디오 재생시간 구하기
			function getDuration() {
				$(document).on("change", $("input[type=file]"), function() {
					// 업로드한 파일 
					let file = document.querySelector("input[type=file]").files[0];
					// 비디오 태그 생성
					let video = document.createElement("video");
					// 파일 리더기 생성
					let reader = new FileReader();
					// 파일은 ArrayBuffer 형식으로 읽음
					reader.readAsArrayBuffer(file);
					// onload되면 실행
					reader.onload = (e) => {
						let buffer = e.target.result;
						// URL 생성 위해 BLOB 형태로 만들기
						let videoBlob = new Blob([new Uint8Array(buffer)], {type: 'video/mp4'});
						let url = window.URL.createObjectURL(videoBlob);
						video.src = url;
						video.addEventListener('loadedmetadata', function() {
							let duration = video.duration;
							document.querySelector("input[name=lectureAttTime]").value = Math.floor(duration/60);
							document.querySelector("input[name=videoPlayTime]").value = duration;
						})
					}	
				})
			}
		</script>
	</th:block>
</body>
</html>